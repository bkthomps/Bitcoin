"""
ECE 458 Project 1
Skeleton solution file.

You need to assign values to variables, and implement two functions as part of your answers to this project
You are not allowed to call any DSA signature package.
You are allowed to define whatever subroutines you like to structure your code.
"""

import hashlib
import binascii
from bitstring import BitArray

"""
sha3_224_hex() is design to take a hexadecimal string as the input and compute it's sha3_224 hash value. 
You may call sha3_224_hex() in your project for both DSA signature and sha3_224 hash computation
Don't directly call hashlib.sha3_224() which only takes a character string (then encode the string to utf-8 format) as the input.
No prefix for the input string, and len(hexstr) is even
e.g.  sha3_224_hex("4c")
"""


def sha3_224_hex(hexstr):
    if len(hexstr) % 2 != 0:
        raise ValueError("Error: Length of hex string should be even")
    m = hashlib.sha3_224()
    data = binascii.a2b_hex(str(hexstr))
    m.update(data)
    return m.hexdigest()


# --------------------------------------------------------------------------------

# Part 1: Copy and paste your parameters here
# p, q, g are DSA domain parameters,
# sk_i (secret keys), pk_i (public keys), k_i (random numbers) are used in each signature and verification
p = 16158504202402426253991131950366800551482053399193655122805051657629706040252641329369229425927219006956473742476903978788728372679662561267749592756478584653187379668070077471640233053267867940899762269855538496229272646267260199331950754561826958115323964167572312112683234368745583189888499363692808195228055638616335542328241242316003188491076953028978519064222347878724668323621195651283341378845128401263313070932229612943555693076384094095923209888318983438374236756194589851339672873194326246553955090805398391550192769994438594243178242766618883803256121122147083299821412091095166213991439958926015606973543
q = 13479974306915323548855049186344013292925286365246579443817723220231
g = 9891663101749060596110525648800442312262047621700008710332290803354419734415239400374092972505760368555033978883727090878798786527869106102125568674515087767296064898813563305491697474743999164538645162593480340614583420272697669459439956057957775664653137969485217890077966731174553543597150973233536157598924038645446910353512441488171918287556367865699357854285249284142568915079933750257270947667792192723621634761458070065748588907955333315440434095504696037685941392628366404344728480845324408489345349308782555446303365930909965625721154544418491662738796491732039598162639642305389549083822675597763407558360

sk1 = 11220749888776492954339096413083083893422039507938296548501135968252
sk2 = 10810499044667035722653261159507721162955748723480446846077454802865
sk3 = 6612169478788972466370031067968020017943128328926601079648755119400

# --------------------------------------------------------------------------------

# Part 2: Assign values that you compute to those parameters as part of your answers to (a) (b) and (c)
# (a) list all prime factors of p-1, list 3 public keys pk_i's corresponding to sk_i's, those numbers should be decimal integers
pfactor1 = 2
pfactor2 = q
pfactor3 = 599352188457547639693740171522680835865322184075286620256386716439921029334782998562008313995103840817116953210359643511447372101221464995653177706653918911634015555633001801773590292023083604552613918655194669929368962688659673544061885990566694774938089095597940505443430714573194211134223784784744939911387314440899638056016474270609853063142638329500429039904897328933858412897374253962878313102199163400319655392723027703101354927814377851954345336880097584669598515815463134218486896858352351187255794957262790967727451704317515673833695348341

pk1 = pow(g, sk1, p)
pk2 = pow(g, sk2, p)
pk3 = pow(g, sk3, p)

lz1 = 2048 - pk1.bit_length()
lz2 = 2048 - pk2.bit_length()
lz3 = 2048 - pk3.bit_length()


# (b) Sig_sk1 and Sig_sk2, k_i is the random number used in signature.
# u, v, w is the intermediate results when verifying Sig_sk1(m1)
# All variables should be decimal integers

# (b)(1)
def create_m1():
    amt1 = BitArray(hex='04')
    build_m1 = BitArray(bin=''.zfill(lz1)) + BitArray(bin="{0:b}".format(pk1))
    build_m1 += BitArray(bin=''.zfill(lz2)) + BitArray(bin="{0:b}".format(pk2)) + amt1
    return build_m1.hex


k1 = int(sha3_224_hex('01'), 16)
r1 = pow(g, k1, p) % q
m1 = create_m1()
z1 = sha3_224_hex(m1)
s1 = (int(z1, 16) + sk1 * r1) * pow(k1, -1, q)
print("sig_sk1(m1) = (" + str(hex(r1)) + ", " + str(hex(s1)) + ")")

# (b)(2)
w = pow(s1, -1, q)
u1 = int(z1, 16) * w % q
u2 = r1 * w % q
v = (pow(g, u1, p) * pow(pk1, u2, p) % p) % q
print("r1 = " + str(hex(r1)))
print("v = " + str(hex(v)))


def sign_user1():
    return Sign(p, q, g, k1, sk1, m1)


def verify_user1(signed):
    return Verify(p, q, g, pk1, m1, signed[0], signed[1])


def sign_and_verify():
    signed = sign_user1()
    return verify_user1(signed)


# (b)(3)
def create_m2():
    amt2 = BitArray(hex='03')
    build_m2 = BitArray(bin=''.zfill(lz2)) + BitArray(bin="{0:b}".format(pk2))
    build_m2 += BitArray(bin=''.zfill(lz3)) + BitArray(bin="{0:b}".format(pk3)) + amt2
    return build_m2.hex


k2 = int(sha3_224_hex('02'), 16)
r2 = pow(g, k2, p) % q
m2 = create_m2()
z2 = sha3_224_hex(m2)
s2 = (int(z2, 16) + sk2 * r2) * pow(k2, -1, q)
print("sig_sk2(m2) = (" + str(hex(r2)) + ", " + str(hex(s2)) + ")")

# (c) PreImageOfPW1=h(amt0)||m1||nonce1, PreImageOfPW2=h(m1)||m2||nonce2,
# those two variables should be hex strings with no prefix of 0x
amt0 = BitArray(hex='05')
h_amt0 = sha3_224_hex(amt0.hex)
print("\nFor first nonce:")
print("len(h_amt0): " + str(4 * len(h_amt0)))
print("h_amt0: " + ''.zfill(224 - int(h_amt0, 16).bit_length()) + bin(int(h_amt0, 16))[2:])
print("len(m1): " + str(4 * len(m1)))
print("m1: " + ''.zfill(4104 - int(m1, 16).bit_length()) + bin(int(m1, 16))[2:])
print("\nFor second nonce:")
h_m1 = sha3_224_hex(m1)
print("len(h_m1): " + str(4 * len(h_m1)))
print("h_m1: " + ''.zfill(224 - int(h_m1, 16).bit_length()) + bin(int(h_m1, 16))[2:])
print("len(m2): " + str(4 * len(m2)))
print("m2: " + ''.zfill(4104 - int(m2, 16).bit_length()) + bin(int(m2, 16))[2:])
print()
# Now go to the C++ program, and input these values

# Put the C++ program output here, and then copy-paste this output below
first_pre_image = "1000101101101111010111011100010110110100000001010101100111110111100001000101010001110001011010110010000010001111101000111000101001111000100101110100001101010101101011011011001000101100011011100011010001111000011111011001110000011101111011110101111100001110010001110100110110011111101000101101000011100111101101100101100101100110111110110100000010010000100110001100000111111110111110000110111100011011101111011110101100100000010001110010111111011001001011101001111111010110111100010000010111111110111010001100001011101011000110000111000101111000001111000011110100010010011110001110010110010100100000011110011000110100110010011011000110011001010111000010100011010100110011110100111010100110100010011010011001001011001100111011000001001001110111101111101000101011011001111010100010011010010100001001011000011100111000011000110101011011010101110110000111000011100010001111110001001011011000001001000100000100110110101110011010001111111100001010111101000111100101011101001000100110000011001101101101000000101000001011000001110100010001010011100111100111100111000011100001010111101111100010100111100000010001111110011110101110111010100011001000001111000100011000111101110110111011001010100100100000000100110101101011000110110000000011111001110000001011101111010100110011101101001001000000001101001011110100111000111110000110011010100110001011000011011100001101100100110110101101000011101011111011010111001110011110010101001011010110001100100000000101001110001100001001011001100001100101000101011111101111001001101111111111111101010000001111101000101001001011101000000111110001000101001101011101111010011000111101011110110000110111111101100010101100000111100110111111110110000110110000011000110101100101101101100110110010110010100000110000010110110011110001000110011110111110011000001010000010010000110011001100011011010100101010110001000000111011011000100101100111110110110011110110010101001111111010101000110100101000100100101010111101100111111111011010001111010011111011100110001100001011000110110011010000011001101110000001011110000010100111110111101110100101101001010100101101100101101111011101000010010111101001101100011111010111111110000010100100111001000110000100100110011010110011111111000010011011101111010001001000111100001001101011011100110110010010101111010101000000011010111100110011001110101101001101110100011110101100000010011101101011101001000110001101011111000111101110101111110101101010001101000100000011110101010111110101100101110000101010000101000111100100101010010100001000100000011001011100010010100101101101011001000100110010011110001001110110011101111000110111010100010010101001101000101100000011111110010101111101010011111101100101110000101101011110110111011010011011011010101010110011110101111000110110001101110011000011000110010111001111010111101000001101011011000011110011110101101010110000000101110101010000111101111010110000010011010101000011100101001010011110011011011111011111001011101100000110000010000000000110000000100011101001001011010111101101000001011111010000111111010100010011100101111010111001100100001110010110001111010000110101100110110000100110011011001000111110101000110111110110001001000110110000000110100000101110011000110110110100010111100001000110011000011011010000100000101101011001000001101100000011001110001101000010111010010001001111110100111000110100111010001110011111100000111000100000100010001010011111000100101001001111111001001100000010111111101110000100111011111100101001011101111101011100101111000111001100001101010011101111000010011011101111000000110011001000011001101000000111001101011101111111101011100001001001111000110010000100001100010111101010011010100100110010010110111101100110000010100101011101101011011010110011101111011001101110101010001001010010110111010111011110010000000111110000110011000001011011001010110001011011110111011111001101100010110110000100101011010111101010011101110100110010011100111010011001101011100100110100110101110011000101010101010110010100000100110010110100001101010000001011011111111111110010000111111010101001100001000011101001001101010001111101101110001111110110110111011010101011001011111000111000111011101011010001000011101110110101110001110010010110100001111101101100100110011101000011110110110111011110001111001110011110100011111101010100100111001101001001000110111111110010001010110100000111111000110000000001101010111111010000010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000001101110110110111100100"
second_pre_image = "0010110100010001110110111111001110001000101101101100001101110101001110101111100111110101100011101111001100111001100001100111100100101100111111111001000011110110111100100111011011001011001110111110000110111011011000101011111101101011110011001100111010110100110111010001111010110000001001110110101110100100011000110101111100011110111010111111010110101000110100010000001111010101011111010110010111000010101000010100011110010010101001010000100010000001100101110001001010010110110101100100010011001001111000100111011001110111100011011101010001001010100110100010110000001111111001010111110101001111110110010111000010110101111011011101101001101101101010101011001111010111100011011000110111001100001100011001011100111101011110100000110101101100001111001111010110101011000000010111010101000011110111101011000001001101010100001110010100101001111001101101111101111100101110110000011000001000000000011000000010001110100100101101011110110100000101111101000011111101010001001110010111101011100110010000111001011000111101000011010110011011000010011001101100100011111010100011011111011000100100011011000000011010000010111001100011011011010001011110000100011001100001101101000010000010110101100100000110110000001100111000110100001011101001000100111111010011100011010011101000111001111110000011100010000010001000101001111100010010100100111111100100110000001011111110111000010011101111110010100101110111110101110010111100011100110000110101001110111100001001101110111100000011001100100001100110100000011100110101110111111110101110000100100111100011001000010000110001011110101001101010010011001001011011110110011000001010010101110110101101101011001110111101100110111010101000100101001011011101011101111001000000011111000011001100000101101100101011000101101111011101111100110110001011011000010010101101011110101001110111010011001001110011101001100110101110010011010011010111001100010101010101011001010000010011001011010000110101000000101101111111111111001000011111101010100110000100001110100100110101000111110110111000111111011011011101101010101100101111100011100011101110101101000100001110111011010111000111001001011010000111110110110010011001110100001111011011011101111000111100111001111010001111110101010010011100110100100100011011111111001000101011010000011111100011000000000110101011111101000011111011100011001001010100111101000001101001110000011010001101110010001000110010000011110011010100111111011101110010001111010011010000001010000100001011010010101000101010011101101001011100001010000110000100000100000010010110101000110000111101000110011000101010101000000011100101101110111000101000001101011110001100100100100011001001101001111001100110001101111110001011101100011001010101011011010011101111001111111100010011100001010001100111101100100000000000011111101011000001101001010001010001110000010001110101001001111100000010110100101011001000011011111001100000010001100011011001110101111011010110101100000111001011000010001111101010010000010000011111110100110000011011110011011100110000111110110101010101100000110100110111011101111111111011111011001001110110011100010111000101100111100110011010000100011010000010111100010010101010001011101100000000001011011101100101010010111011011111101101011010011000000011000110010000010101111110111100001000010000010100110001001010000111111111000110010101110000001100001101001011101000110011100101001010001000001100011011011111010010110010001001010000100101011110100101000010100000101000000111100101111101101111000001011101011011111111010010110100100111011110001000111110000000000111101010001101000000111100111011000111010101001110111101010101011000101011111001000110110100001001100000001110101010100000011010110011110110100010011011100000110001110101010010011101011010000110000111001000001010101100011010100001010011010100001001010011101011101100110111100000010111001000011101111010101001000001111000010101001000011101110000000001010101111000101010000101011101011110100110110110001101011000111011111000101000101010101111010100001110111111010010001001110111011110110101110000001101011110010100111001101110010000101010001010011011001100011100010110110000100001111100011010001101101100110101000110010001010000101000001101010110110101000010111000000001100010100111101001100010101000011011100010011101100010011110010000001101010100101101011011100110100110100101101100011010010111110101101111001000011011100000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110011110000110000101111010"
print(BitArray(bin=first_pre_image).hex)
print(BitArray(bin=second_pre_image).hex)

PreImageOfPW1 = "8b6f5dc5b40559f78454716b208fa38a78974355adb22c6e34787d9c1def5f0e474d9fa2d0e7b65966fb409098c1fef86f1bbdeb20472fd92e9fd6f105fee8c2eb1871783c3d1278e59481e634c9b1995c28d4cf4ea689a64b33b049defa2b67a89a50961ce18d5b5761c388fc4b609104dae68ff0af4795d2260cdb40a0b0744539e79c3857be29e047e7aeea320f118f76eca920135ac6c03e702ef533b4900d2f4e3e19a98b0dc364dad0ebed739e54b58c80538c25986515fbc9bfff503e8a4ba07c4535de98f5ec37f62b079bfd86c18d65b66cb28305b3c467be60a090ccc6d4ab103b6259f6cf654fea8d2892af67fda3d3ee630b1b3419b817829f7ba5a54b65bdd097a6c7d7f8293918499acff09bbd123c26b7364af5406bccceb4dd1eb0276ba4635f1eebf5a8d103d57d65c2a14792a50881971296d644c9e276778dd44a9a2c0fe57d4fd970b5edda6daab3d78d8dcc31973d7a0d6c3cf5ab017543deb04d50e529e6df7cbb060801808e92d7b417d0fd44e5eb990e58f4359b099b23ea37d891b01a0b98db45e11986d082d641b0338d0ba44fd38d3a39f83882229f1293f9302fee13bf2977d72f1cc353bc26ef033219a0735dfeb849e3210c5ea6a4c96f660a576b6b3bd9baa252dd77901f0cc16cac5bddf362d84ad7a9dd3273a66b934d73155594132d0d40b7ffc87ea9843a4d47db8fdb76ab2f8e3bad10eed71c9687db26743db778f39e8fd5273491bfc8ad07e3006afd0440000000000000000000000010376de4"
PreImageOfPW2 = "2d11dbf388b6c3753af9f58ef33986792cff90f6f276cb3be1bb62bf6bccceb4dd1eb0276ba4635f1eebf5a8d103d57d65c2a14792a50881971296d644c9e276778dd44a9a2c0fe57d4fd970b5edda6daab3d78d8dcc31973d7a0d6c3cf5ab017543deb04d50e529e6df7cbb060801808e92d7b417d0fd44e5eb990e58f4359b099b23ea37d891b01a0b98db45e11986d082d641b0338d0ba44fd38d3a39f83882229f1293f9302fee13bf2977d72f1cc353bc26ef033219a0735dfeb849e3210c5ea6a4c96f660a576b6b3bd9baa252dd77901f0cc16cac5bddf362d84ad7a9dd3273a66b934d73155594132d0d40b7ffc87ea9843a4d47db8fdb76ab2f8e3bad10eed71c9687db26743db778f39e8fd5273491bfc8ad07e3006afd0fb8c953d069c1a3722320f353f7723d340a10b4a8a9da5c286104096a30f4662aa0396ee2835e3248c9a7998df8bb1955b4ef3fc4e1467b2001fac1a5147047527c0b4ac86f98118d9d7b5ac1cb08fa9041fd306f3730fb5560d3777fefb27671716799a11a0bc4aa2ec00b7654bb7ed6980c6415fbc210531287fc657030d2e8ce528831b7d2c894257a50a0a0797dbc175bfd2d27788f801ea340f3b1d53bd558af91b42603aa81acf689b831d5275a18720ab1a8535094ebb3781721dea9078548770055e2a15d7a6d8d63be28aaf50efd22777b5c0d794e6e42a29b31c5b087c68db35191428356d42e018a7a62a1b89d89e40d52d6e69a5b1a5f5bc86e030000000000000000000000000678617a"

# Confirm that first 32 bits are 0 (first 8 hex)
print(sha3_224_hex(PreImageOfPW1))
print(sha3_224_hex(PreImageOfPW2))


# --------------------------------------------------------------------------------

# Part 3: DSA signature and verification
# DSA signature function, p, q, g, k, sk are integers, Message are hex strings of even length.
def Sign(p, q, g, k, sk, Message):
    r = pow(g, k, p) % q
    z = sha3_224_hex(Message)
    s = (int(z, 16) + sk * r) * pow(k, -1, q)
    return r, s


# DSA verification function, p, q, g, k, pk are integers, Message are hex strings of even length.
def Verify(p, q, g, pk, Message, r, s):
    w = pow(s, -1, q)
    z = sha3_224_hex(Message)
    u1 = int(z, 16) * w % q
    u2 = r * w % q
    v = (pow(g, u1, p) * pow(pk, u2, p) % p) % q
    return r == v


print(sign_and_verify())
